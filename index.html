<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 UtiliHub - Your All-in-One Utility Tools Hub</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
if (typeof pdfjsLib !== 'undefined') {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* Usage Tracker */
        .usage-tracker {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .tier-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .current-tier {
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
        }

        .tier-anonymous { background: #6c757d; }
        .tier-free { background: #28a745; }
        .tier-premium1 { background: #fd7e14; }
        .tier-premium2 { background: #6f42c1; }
        .tier-premium3 { background: #dc3545; }

        .usage-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }

        .usage-fill {
            height: 100%;
            transition: all 0.3s ease;
            border-radius: 10px;
        }

        .usage-green { background: #28a745; }
        .usage-yellow { background: #ffc107; }
        .usage-red { background: #dc3545; }

        /* Tool Grid */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .tool-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .tool-card.active {
            border: 2px solid #667eea;
            transform: translateY(-5px);
        }

        .tool-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .tool-card p {
            color: #666;
            margin-bottom: 15px;
            flex-grow: 1;
        }

        .tool-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-working { background: #d1edff; color: #0066cc; }
        .status-priority { background: #fff3cd; color: #856404; }
        .status-coming-soon { background: #f8d7da; color: #721c24; }

        /* Tool Modal */
        .tool-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .tool-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .tool-modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .tool-modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .tool-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5em;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .tool-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .tool-modal-body {
            padding: 30px;
        }

          /* PDF Converter Layout Fix */
        .pdf-converter-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
        }

        /* File Upload Areas */
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #764ba2;
            background: #f0f2ff;
            transform: scale(1.02);
        }

        .upload-area.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #f5f5f5;
            border-color: #ccc;
        }

        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #666;
            font-size: 0.9em;
        }

        /* Buttons */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Form Controls */
        .form-group {
            margin: 15px 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Processing Overlay */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .processing-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .processing-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e9ecef;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* File List */
        .file-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin: 5px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .file-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .file-icon {
            margin-right: 10px;
            font-size: 1.5em;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .file-size {
            font-size: 0.85em;
            color: #666;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1002;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: #28a745;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.warning {
            background: #ffc107;
            color: #212529;
        }

        /* Calculator Styles */
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            max-width: 500px;
            margin: 0 auto;
        }

        .calc-btn {
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calc-btn:hover {
            transform: scale(1.05);
        }

        .calc-btn:active {
            transform: scale(0.95);
        }

        /* File Name Modal */
        .filename-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1003;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .filename-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .filename-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
        }

        /* Batch Processing Options */
        .batch-options {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }

        .batch-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .batch-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .batch-option.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        /* Text Stats Grid */
        .text-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .text-stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .text-stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            display: block;
        }

        .text-stat-label {
            color: #666;
            font-size: 0.9em;
        }

        /* Enhanced Image Editor Styles */
        .image-editor-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin: 20px 0;
        }

        .image-preview-area {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .image-controls-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .filter-controls {
            margin: 20px 0;
        }

        .filter-group {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #e9ecef;
        }

        .filter-group h5 {
            margin-bottom: 15px;
            color: #333;
        }

        .canvas-container {
            text-align: center;
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .canvas-container canvas {
            max-width: 100%;
            max-height: 500px;
        }

        .advanced-tools {
            margin: 20px 0;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            border: 1px solid #ffeaa7;
        }

        /* URL Shortener Styles */
        .url-display {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }

        .url-display.show {
            display: block;
        }

        .short-url {
            font-family: monospace;
            font-size: 1.1em;
            color: #667eea;
            word-break: break-all;
        }

        .analytics-display {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .analytics-display.show {
            display: block;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .analytics-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .analytics-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .analytics-label {
            color: #666;
            font-size: 0.9em;
        }

        /* QR Code Styles */
        .qr-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .qr-preview {
            text-align: center;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        .qr-preview canvas {
            max-width: 100%;
            border-radius: 8px;
            background: white;
            padding: 10px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .tools-grid {
                grid-template-columns: 1fr;
            }

            .tier-info {
                flex-direction: column;
                text-align: center;
            }

            .upload-area {
                padding: 20px;
            }

            .btn {
                width: 100%;
                margin: 10px 0;
            }

            .tool-modal-content {
                width: 95%;
                max-height: 95vh;
            }

            .tool-modal-body {
                padding: 20px;
            }

            .calculator-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .image-editor-container {
                grid-template-columns: 1fr;
            }

            .qr-options {
                grid-template-columns: 1fr;
            }
		
             .pdf-converter-layout {
              grid-template-columns: 1fr;
              gap: 20px;
            }
        }

        /* Pricing Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .pricing-card {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .pricing-card:hover, .pricing-card.current {
            border-color: #667eea;
            transform: translateY(-5px);
        }

        .pricing-card.current {
            background: #f8f9ff;
        }

        .price {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .features {
            text-align: left;
            margin: 15px 0;
        }

        .features li {
            margin: 5px 0;
            color: #666;
        }

        /* Demo Controls */
        .demo-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1004;
            display: none;
        }

        .demo-controls.active {
            display: block;
        }

        .demo-controls select {
            margin: 5px;
            padding: 5px;
            border-radius: 5px;
            border: none;
        }

        /* Text Overlay Tool */
        .text-overlay-controls {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }

        .color-picker-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }

        .color-picker {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="demo-controls" id="demoControls">
        <h4>Demo Mode</h4>
        <select id="demoTierSelect">
            <option value="anonymous">Anonymous</option>
            <option value="free">Free Account</option>
            <option value="premium1">Premium Tier 1</option>
            <option value="premium2">Premium Tier 2</option>
            <option value="premium3">Premium Tier 3</option>
        </select>
        <button onclick="resetUsage()" class="btn btn-secondary" style="margin-top: 10px;">Reset Usage</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>🚀 UtiliHub</h1>
            <p>Your All-in-One Utility Tools Hub</p>
            <p style="opacity: 0.8;">No downloads, no signups - just instant results</p>
        </div>

        <!-- Usage Tracker -->
        <div class="usage-tracker">
            <div class="tier-info">
                <div class="current-tier" id="currentTier">Anonymous User</div>
                <div class="usage-stats" id="usageStats">0 / 5 files used today</div>
                <button class="btn btn-warning" onclick="showPricing()">Upgrade Plan</button>
            </div>
            <div class="usage-bar">
                <div class="usage-fill usage-green" id="usageFill" style="width: 0%"></div>
            </div>
            <div style="font-size: 0.9em; color: #666; text-align: center;" id="resetTimer">
                Resets in: 24h 0m
            </div>
        </div>

        <!-- Tools Grid -->
        <div class="tools-grid">
            <div class="tool-card" onclick="openTool('pdf-converter')">
                <div>
                    <h3>📄 Convert PDFs </h3>
                    <p>Convert PDFs to text, Word documents, Excel sheets, CSV files with advanced table extraction</p>
                </div>
                <span class="tool-status status-working">✅ Working</span>
            </div>

            <div class="tool-card" onclick="openTool('pdf-to-formats')">
                <div>
                    <h3>📋 Convert to PDF</h3>
                    <p>Convert documents, images, and text files to PDF format with custom naming</p>
                </div>
                <span class="tool-status status-working">✅ Working</span>
            </div>

            <div class="tool-card" onclick="openTool('image-converter')">
                <div>
                    <h3>🖼️ Advanced Image Editor</h3>
                    <p>Convert formats, apply filters, add text/frames, Live Photo to GIF conversion, and more</p>
                </div>
                <span class="tool-status status-working">✅ Working</span>
            </div>

            <div class="tool-card" onclick="openTool('calculator')">
                <div>
                    <h3>🧮 Smart Calculator</h3>
                    <p>Advanced calculator with scientific functions and history</p>
                </div>
                <span class="tool-status status-working">✅ Working</span>
            </div>

            <div class="tool-card" onclick="openTool('text-tools')">
                <div>
                    <h3>✏️ Text Tools</h3>
                    <p>Word count, character count, case conversion, and text formatting</p>
                </div>
                <span class="tool-status status-working">✅ Working</span>
            </div>

            <!-- Newly Implemented Tools -->
            <div class="tool-card" onclick="openTool('url-shortener')">
                <div>
                    <h3>🔗 URL Shortener</h3>
                    <p>Create custom short links with analytics and password protection</p>
                </div>
                <span class="tool-status status-working">✅ Working</span>
            </div>

            <div class="tool-card" onclick="openTool('qr-generator')">
                <div>
                    <h3>📱 QR Code Generator</h3>
                    <p>Generate QR codes with multiple formats and custom styling options</p>
                </div>
                <span class="tool-status status-working">✅ Working</span>
            </div>

            <!-- Coming Soon Tools -->
            <div class="tool-card" style="opacity: 0.7;">
                <div>
                    <h3>🎨 Color Tools</h3>
                    <p>Color picker, converter, palette generator, and accessibility checker</p>
                </div>
                <span class="tool-status status-coming-soon">🚧 Coming Soon</span>
            </div>

                            <div class="tool-card" style="opacity: 0.7;">
                <div>
                    <h3>🔒 Password Generator</h3>
                    <p>Generate secure passwords with customizable length and character sets</p>
                </div>
                <span class="tool-status status-coming-soon">🚧 Coming Soon</span>
            </div>

            <div class="tool-card" style="opacity: 0.7;">
                <div>
                    <h3>🔤 Base64 Encoder/Decoder</h3>
                    <p>Encode and decode text and files with Base64 algorithm</p>
                </div>
                <span class="tool-status status-coming-soon">🚧 Coming Soon</span>
            </div>

            <div class="tool-card" style="opacity: 0.7;">
                <div>
                    <h3>🔐 Hash Generator</h3>
                    <p>Generate MD5, SHA-1, SHA-256, and other hash algorithms</p>
                </div>
                <span class="tool-status status-coming-soon">🚧 Coming Soon</span>
            </div>

            <div class="tool-card" style="opacity: 0.7;">
                <div>
                    <h3>📋 JSON Formatter</h3>
                    <p>Format, validate, minify, and beautify JSON data</p>
                </div>
                <span class="tool-status status-coming-soon">🚧 Coming Soon</span>
            </div>
        </div>
    </div>

<!-- PDF Converter Modal -->
    <div class="tool-modal" id="pdf-converter-modal">
        <div class="tool-modal-content">
            <div class="tool-modal-header">
                <h2>📄 Convert PDFs </h2>
                <button class="tool-modal-close" onclick="closeTool()">&times;</button>
            </div>
            <div class="tool-modal-body">
                <p>Extract text, tables, and data from PDF files and convert to various formats with advanced table detection</p>

                <!-- Fixed Layout: Side by Side -->
                <div class="pdf-converter-layout">
                    <!-- Batch Options -->
                    <div class="batch-options" id="pdfBatchOptions">
                        <h4>Processing Options</h4>
                        <div class="batch-option selected" id="singlePdfOption" onclick="selectBatchOption('pdf', 'single')">
                            <div>
                                <strong>Process Single File</strong>
                                <div style="font-size: 0.9em; color: #666;">Convert one PDF at a time</div>
                            </div>
                            <div style="color: #28a745; font-weight: bold;">Available</div>
                        </div>
                        <div class="batch-option" id="batchPdfOption" onclick="selectBatchOption('pdf', 'batch')">
                            <div>
                                <strong>Process Multiple Files</strong>
                                <div style="font-size: 0.9em; color: #666;" id="pdfBatchDescription">Batch convert multiple PDFs</div>
                            </div>
                            <div style="color: #dc3545; font-weight: bold;" id="pdfBatchStatus">Upgrade Required</div>
                        </div>
                        
                        <!-- Batch Processing Options (shown only when batch is selected) -->
                        <div id="batchProcessingOptions" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9ff; border-radius: 8px; border: 1px solid #e9ecef;">
                            <h5>Batch Processing Mode</h5>
                            <div class="batch-option" id="combineOption" onclick="selectCombineOption('combine')">
                                <div>
                                    <strong>Combine All Files</strong>
                                    <div style="font-size: 0.9em; color: #666;">Merge all PDFs into one output file</div>
                                </div>
                                <input type="radio" name="combineMode" value="combine" checked>
                            </div>
                            <div class="batch-option" id="separateOption" onclick="selectCombineOption('separate')">
                                <div>
                                    <strong>Process Separately</strong>
                                    <div style="font-size: 0.9em; color: #666;">Convert each PDF to individual files</div>
                                </div>
                                <input type="radio" name="combineMode" value="separate">
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="upload-area" id="pdfUploadArea" onclick="document.getElementById('pdfFileInput').click()">
                            <div class="upload-icon">📄</div>
                            <div class="upload-text">Drag & drop your PDF files here or click to select</div>
                            <div class="upload-subtext">Supports: .pdf files</div>
                        </div>
                        <input type="file" id="pdfFileInput" multiple accept=".pdf" style="display: none;">
                        
                        <div class="form-group">
                            <label class="form-label">Output Format</label>
                            <select class="form-control" id="pdfOutputFormat">
                                <option value="txt">Plain Text (.txt)</option>
                                <option value="docx">Word Document (.docx)</option>
                                <option value="csv">CSV File (.csv)</option>
                                <option value="json">JSON Data (.json)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="detectTables" checked> 
                                Advanced Table Detection (Recommended for CSV)
                            </label>
                            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                Automatically detects and preserves table structures in PDFs
                            </div>
                        </div>
                    </div>
                </div>

                <div class="file-list" id="pdfFileList" style="display: none;"></div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-primary" id="convertPdfBtn" onclick="convertPdfToFormat()">Convert PDF</button>
                    <button class="btn btn-secondary" onclick="clearFiles('pdf')">Clear Files</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF to Formats Modal -->
    <div class="tool-modal" id="pdf-to-formats-modal">
        <div class="tool-modal-content">
            <div class="tool-modal-header">
                <h2>📋 Convert to PDF</h2>
                <button class="tool-modal-close" onclick="closeTool()">&times;</button>
            </div>
            <div class="tool-modal-body">
                <p>Convert documents (.doc, .docx, .txt) and images to PDF format</p>
                
                <!-- Batch Options -->
                <div class="batch-options" id="toPdfBatchOptions">
                    <h4>Processing Options</h4>
                    <div class="batch-option selected" id="singleToPdfOption" onclick="selectBatchOption('toPdf', 'single')">
                        <div>
                            <strong>Process Single File</strong>
                            <div style="font-size: 0.9em; color: #666;">Convert one file at a time</div>
                        </div>
                        <div style="color: #28a745; font-weight: bold;">Available</div>
                    </div>
                    <div class="batch-option" id="batchToPdfOption" onclick="selectBatchOption('toPdf', 'batch')">
                        <div>
                            <strong>Process Multiple Files</strong>
                            <div style="font-size: 0.9em; color: #666;" id="toPdfBatchDescription">Batch convert multiple files</div>
                        </div>
                        <div style="color: #dc3545; font-weight: bold;" id="toPdfBatchStatus">Upgrade Required</div>
                    </div>
                </div>
                
                <div class="upload-area" id="toPdfUploadArea" onclick="document.getElementById('toPdfFileInput').click()">
                    <div class="upload-icon">📂</div>
                    <div class="upload-text">Drag & drop your files here or click to select</div>
                    <div class="upload-subtext">Supports: .doc, .docx, .txt, .jpg, .png, .gif, .bmp, .tiff</div>
                </div>
                <input type="file" id="toPdfFileInput" multiple accept=".doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.bmp,.tiff" style="display: none;">
                
                <div class="file-list" id="toPdfFileList" style="display: none;"></div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-primary" id="convertToPdfBtn" onclick="convertToPdf()">Convert to PDF</button>
                    <button class="btn btn-secondary" onclick="clearFiles('toPdf')">Clear Files</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Image Editor Modal -->
    <div class="tool-modal" id="image-converter-modal">
        <div class="tool-modal-content">
            <div class="tool-modal-header">
                <h2>🖼️ Advanced Image Editor</h2>
                <button class="tool-modal-close" onclick="closeTool()">&times;</button>
            </div>
            <div class="tool-modal-body">
                <p>Convert formats, apply filters, add text/frames, edit, compress, and enhance your images</p>
                
                <!-- Batch Options -->
                <div class="batch-options" id="imageBatchOptions">
                    <h4>Processing Options</h4>
                    <div class="batch-option selected" id="singleImageOption" onclick="selectBatchOption('image', 'single')">
                        <div>
                            <strong>Process Single Image</strong>
                            <div style="font-size: 0.9em; color: #666;">Edit one image at a time</div>
                        </div>
                        <div style="color: #28a745; font-weight: bold;">Available</div>
                    </div>
                    <div class="batch-option" id="batchImageOption" onclick="selectBatchOption('image', 'batch')">
                        <div>
                            <strong>Process Multiple Images</strong>
                            <div style="font-size: 0.9em; color: #666;" id="imageBatchDescription">Batch process multiple images</div>
                        </div>
                        <div style="color: #dc3545; font-weight: bold;" id="imageBatchStatus">Upgrade Required</div>
                    </div>
                </div>
                
                <div class="upload-area" id="imageUploadArea" onclick="document.getElementById('imageFileInput').click()">
                    <div class="upload-icon">🖼️</div>
                    <div class="upload-text">Drag & drop your images here or click to select</div>
                    <div class="upload-subtext">Supports: JPG, PNG, GIF, BMP, TIFF, WebP, SVG, Live Photos (HEIC)</div>
                </div>
                <input type="file" id="imageFileInput" multiple accept="image/*,.heic" style="display: none;">
                
                <div class="image-editor-container">
                    <div class="image-preview-area">
                        <div class="canvas-container" id="imagePreview" style="display: none;">
                            <canvas id="imageCanvas" style="max-width: 100%; max-height: 500px;"></canvas>
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-success" id="downloadImageBtn" onclick="downloadProcessedImage()" style="display: none;">Download Result</button>
                        </div>
                    </div>

                    <div class="image-controls-panel">
                        <div class="filter-group">
                            <h5>Format Conversion</h5>
                            <div class="form-group">
                                <label class="form-label">Convert To</label>
                                <select class="form-control" id="imageFormat">
                                    <option value="png">PNG</option>
                                    <option value="jpg">JPEG</option>
                                    <option value="webp">WebP</option>
                                    <option value="gif">GIF</option>
                                    <option value="bmp">BMP</option>
                                    <option value="tiff">TIFF</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quality (JPEG/WebP): <span id="qualityValue">80</span>%</label>
                                <input type="range" class="form-control" id="imageQuality" min="10" max="100" value="80" 
                                       oninput="document.getElementById('qualityValue').textContent = this.value">
                            </div>
                        </div>

                        <div class="filter-group">
                            <h5>Basic Filters</h5>
                            <div class="form-group">
                                <label class="form-label">Brightness: <span id="brightnessValue">0</span></label>
                                <input type="range" class="form-control" id="brightness" min="-100" max="100" value="0" 
                                       oninput="document.getElementById('brightnessValue').textContent = this.value; applyFilters()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contrast: <span id="contrastValue">0</span></label>
                                <input type="range" class="form-control" id="contrast" min="-100" max="100" value="0" 
                                       oninput="document.getElementById('contrastValue').textContent = this.value; applyFilters()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Saturation: <span id="saturationValue">0</span></label>
                                <input type="range" class="form-control" id="saturation" min="-100" max="100" value="0" 
                                       oninput="document.getElementById('saturationValue').textContent = this.value; applyFilters()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Blur: <span id="blurValue">0</span>px</label>
                                <input type="range" class="form-control" id="blur" min="0" max="20" value="0" 
                                       oninput="document.getElementById('blurValue').textContent = this.value; applyFilters()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Hue Rotate: <span id="hueValue">0</span>°</label>
                                <input type="range" class="form-control" id="hueRotate" min="0" max="360" value="0" 
                                       oninput="document.getElementById('hueValue').textContent = this.value; applyFilters()">
                            </div>
                        </div>

                        <div class="filter-group">
                            <h5>Quick Filters</h5>
                            <button class="btn btn-secondary" onclick="applyPresetFilter('grayscale')">Grayscale</button>
                            <button class="btn btn-secondary" onclick="applyPresetFilter('sepia')">Sepia</button>
                            <button class="btn btn-secondary" onclick="applyPresetFilter('vintage')">Vintage</button>
                            <button class="btn btn-secondary" onclick="applyPresetFilter('invert')">Invert</button>
                            <button class="btn btn-secondary" onclick="applyPresetFilter('warm')">Warm</button>
                            <button class="btn btn-secondary" onclick="applyPresetFilter('cool')">Cool</button>
                            <button class="btn btn-secondary" onclick="resetFilters()">Reset All</button>
                        </div>

                        <div class="filter-group">
                            <h5>Image Tools</h5>
                            <button class="btn btn-warning" onclick="removeBackground()">Remove Background</button>
                            <button class="btn btn-warning" onclick="compressImage()">Compress</button>
                            <button class="btn btn-warning" onclick="resizeImage()">Resize</button>
                            <button class="btn btn-warning" onclick="cropImage()">Crop</button>
                        </div>

                        <div class="text-overlay-controls">
                            <h5>Text Overlay</h5>
                            <div class="form-group">
                                <input type="text" class="form-control" id="overlayText" placeholder="Enter text to add">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Font Size: <span id="fontSizeValue">24</span>px</label>
                                <input type="range" class="form-control" id="fontSize" min="12" max="72" value="24" 
                                       oninput="document.getElementById('fontSizeValue').textContent = this.value">
                            </div>
                            <div class="color-picker-group">
                                <label class="form-label">Text Color:</label>
                                <input type="color" class="color-picker" id="textColor" value="#ffffff">
                                <label class="form-label">Background:</label>
                                <input type="color" class="color-picker" id="textBgColor" value="#000000">
                            </div>
                            <button class="btn btn-primary" onclick="addTextOverlay()">Add Text</button>
                        </div>

                        <div class="filter-group">
                            <h5>Special Features</h5>
                            <button class="btn btn-warning" onclick="convertLivePhotoToGif()">Live Photo → GIF</button>
                            <button class="btn btn-warning" onclick="removeWatermark()">Remove Watermark</button>
                        </div>
                    </div>
                </div>

                <div class="file-list" id="imageFileList" style="display: none;"></div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-primary" id="processImageBtn" onclick="processImages()">Process Images</button>
                    <button class="btn btn-secondary" onclick="clearFiles('image')">Clear Files</button>
                </div>
            </div>
        </div>
    </div>

    <!-- URL Shortener Modal -->
    <div class="tool-modal" id="url-shortener-modal">
        <div class="tool-modal-content">
            <div class="tool-modal-header">
                <h2>🔗 URL Shortener</h2>
                <button class="tool-modal-close" onclick="closeTool()">&times;</button>
            </div>
            <div class="tool-modal-body">
                <p>Create custom short links with analytics and password protection</p>
                
                <div class="form-group">
                    <label class="form-label">Original URL</label>
                    <input type="url" class="form-control" id="originalUrl" placeholder="https://example.com/very-long-url">
                </div>

                <div class="form-group">
                    <label class="form-label">Custom Short Code (Optional)</label>
                    <input type="text" class="form-control" id="customCode" placeholder="my-link">
                    <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                        Leave empty for auto-generated code
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Password Protection (Optional)</label>
                    <input type="password" class="form-control" id="linkPassword" placeholder="Enter password">
                </div>

                <div class="form-group">
                    <label class="form-label">Expiration (Optional)</label>
                    <select class="form-control" id="linkExpiration">
                        <option value="">Never expires</option>
                        <option value="1">1 day</option>
                        <option value="7">1 week</option>
                        <option value="30">1 month</option>
                        <option value="365">1 year</option>
                    </select>
                </div>

                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-primary" onclick="createShortUrl()">Create Short URL</button>
                </div>

                <div class="url-display" id="urlDisplay">
                    <h4>Your Short URL:</h4>
                    <div class="short-url" id="shortUrl"></div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="copyShortUrl()">Copy URL</button>
                        <button class="btn btn-secondary" onclick="showAnalytics()">View Analytics</button>
                    </div>
                </div>

                <div class="analytics-display" id="analyticsDisplay">
                    <h4>Analytics</h4>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-value" id="totalClicks">0</div>
                            <div class="analytics-label">Total Clicks</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value" id="uniqueClicks">0</div>
                            <div class="analytics-label">Unique Visitors</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value" id="todayClicks">0</div>
                            <div class="analytics-label">Today's Clicks</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-value" id="weekClicks">0</div>
                            <div class="analytics-label">This Week</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Generator Modal -->
    <div class="tool-modal" id="qr-generator-modal">
        <div class="tool-modal-content">
            <div class="tool-modal-header">
                <h2>📱 QR Code Generator</h2>
                <button class="tool-modal-close" onclick="closeTool()">&times;</button>
            </div>
            <div class="tool-modal-body">
                <p>Generate QR codes with multiple formats and custom styling options</p>
                
                <div class="qr-options">
                    <div>
                        <div class="form-group">
                            <label class="form-label">Content Type</label>
                            <select class="form-control" id="qrType" onchange="updateQrInputs()">
                                <option value="url">Website URL</option>
                                <option value="text">Plain Text</option>
                                <option value="email">Email</option>
                                <option value="phone">Phone Number</option>
                                <option value="sms">SMS</option>
                                <option value="wifi">WiFi</option>
                                <option value="vcard">Contact Card</option>
                            </select>
                        </div>

                        <div id="qrInputs">
                            <div class="form-group">
                                <label class="form-label">URL</label>
                                <input type="url" class="form-control" id="qrUrl" placeholder="https://example.com">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Size: <span id="qrSizeValue">200</span>px</label>
                            <input type="range" class="form-control" id="qrSize" min="100" max="500" value="200" 
                                   oninput="document.getElementById('qrSizeValue').textContent = this.value; generateQrCode()">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Error Correction Level</label>
                            <select class="form-control" id="qrErrorLevel" onchange="generateQrCode()">
                                <option value="L">Low (7%)</option>
                                <option value="M" selected>Medium (15%)</option>
                                <option value="Q">Quartile (25%)</option>
                                <option value="H">High (30%)</option>
                            </select>
                        </div>

                        <div class="color-picker-group">
                            <label class="form-label">Foreground:</label>
                            <input type="color" class="color-picker" id="qrForeground" value="#000000" onchange="generateQrCode()">
                            <label class="form-label">Background:</label>
                            <input type="color" class="color-picker" id="qrBackground" value="#ffffff" onchange="generateQrCode()">
                        </div>

                        <div style="text-align: center; margin: 20px 0;">
                            <button class="btn btn-primary" onclick="generateQrCode()">Generate QR Code</button>
                        </div>
                    </div>

                    <div class="qr-preview">
                        <h5>QR Code Preview</h5>
                        <canvas id="qrCanvas" style="display: none;"></canvas>
                        <div id="qrPlaceholder" style="padding: 50px; color: #666;">
                            QR code will appear here
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" id="downloadQrBtn" onclick="downloadQrCode()" style="display: none;">Download QR Code</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div class="tool-modal" id="calculator-modal">
        <div class="tool-modal-content">
            <div class="tool-modal-header">
                <h2>🧮 Smart Calculator</h2>
                <button class="tool-modal-close" onclick="closeTool()">&times;</button>
            </div>
            <div class="tool-modal-body">
                <p>Advanced calculator with scientific functions and calculation history</p>
                
                <div style="max-width: 500px; margin: 0 auto;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <input type="text" class="form-control" id="calcDisplay" readonly 
                               style="font-size: 1.5em; text-align: right; background: white; margin-bottom: 10px;">
                        <div style="font-size: 0.9em; color: #666; text-align: right;" id="calcHistory"></div>
                    </div>
                    
                    <div class="calculator-grid">
                        <!-- Row 1: Functions -->
                        <button class="btn btn-secondary calc-btn" onclick="clearCalc()">C</button>
                        <button class="btn btn-secondary calc-btn" onclick="calcFunction('sqrt')">√</button>
                        <button class="btn btn-secondary calc-btn" onclick="calcFunction('pow')">x²</button>
                        <button class="btn btn-secondary calc-btn" onclick="calcFunction('pow3')">x³</button>
                        <button class="btn btn-secondary calc-btn" onclick="calcOperation('/')">÷</button>
                        
                        <!-- Row 2: Scientific Functions -->
                        <button class="btn btn-secondary calc-btn" onclick="calcFunction('sin')">sin</button>
                        <button class="btn btn-primary calc-btn" onclick="calcNumber('7')">7</button>
                        <button class="btn btn-primary calc-btn" onclick="calcNumber('8')">8</button>
                        <button class="btn btn-primary calc-btn" onclick="calcNumber('9')">9</button>
                        <button class="btn btn-warning calc-btn" onclick="calcOperation('*')">×</button>
                        
                        <!-- Row 3: More Functions -->
                        <button class="btn btn-secondary calc-btn" onclick="calcFunction('cos')">cos</button>
                        <button class="btn btn-primary calc-btn" onclick="calcNumber('4')">4</button>
                        <button class="btn btn-primary calc-btn" onclick="calcNumber('5')">5</button>
                        <button class="btn btn-primary calc-btn" onclick="calcNumber('6')">6</button>
                        <button class="btn btn-warning calc-btn" onclick="calcOperation('-')">-</button>
                        
                        <!-- Row 4: More Functions -->
                        <button class="btn btn-secondary calc-btn" onclick="calcFunction('tan')">tan</button>
                        <button class="btn btn-primary calc-btn" onclick="calcNumber('1')">1</button>
                        <button class="btn btn-primary calc-btn" onclick="calcNumber('2')">2</button>
                        <button class="btn btn-primary calc-btn" onclick="calcNumber('3')">3</button>
                        <button class="btn btn-warning calc-btn" onclick="calcOperation('+')">+</button>
                        
                        <!-- Row 5: Final Functions -->
                        <button class="btn btn-secondary calc-btn" onclick="calcFunction('log')">log</button>
                        <button class="btn btn-primary calc-btn" onclick="calcNumber('0')" style="grid-column: span 2;">0</button>
                        <button class="btn btn-primary calc-btn" onclick="calcNumber('.')">.</button>
                        <button class="btn btn-success calc-btn" onclick="calcEquals()">=</button>
                        
                        <!-- Row 6: Additional Functions -->
                        <button class="btn btn-secondary calc-btn" onclick="calcFunction('ln')">ln</button>
                        <button class="btn btn-secondary calc-btn" onclick="calcFunction('exp')">e^x</button>
                        <button class="btn btn-secondary calc-btn" onclick="calcOperation('%')">%</button>
                        <button class="btn btn-secondary calc-btn" onclick="calcFunction('reciprocal')">1/x</button>
                        <button class="btn btn-secondary calc-btn" onclick="calcOperation('±')">±</button>
                    </div>
                    
                    <div style="margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        <h4>History</h4>
                        <div id="calcHistoryList" style="max-height: 150px; overflow-y: auto;">
                            <p style="color: #666; font-style: italic;">No calculations yet</p>
                        </div>
                        <button class="btn btn-secondary" onclick="clearHistory()" style="margin-top: 10px; padding: 8px 16px; font-size: 0.9em;">Clear History</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Text Tools Modal -->
    <div class="tool-modal" id="text-tools-modal">
        <div class="tool-modal-content">
            <div class="tool-modal-header">
                <h2>✏️ Text Tools</h2>
                <button class="tool-modal-close" onclick="closeTool()">&times;</button>
            </div>
            <div class="tool-modal-body">
                <p>Word count, character count, case conversion, and text formatting</p>
                
                <div style="display: flex; gap: 20px; margin: 20px 0;">
                    <div style="flex: 1;">
                        <h4>Type Text</h4>
                        <textarea class="form-control" id="textInput" rows="10" placeholder="Type or paste your text here..."
                                  oninput="updateTextStats()"></textarea>
                    </div>
                    <div style="width: 200px;">
                        <h4>Or Upload File</h4>
                        <div class="upload-area" onclick="document.getElementById('textFileUpload').click()" 
                             style="padding: 20px; height: 150px; display: flex; flex-direction: column; justify-content: center;">
                            <div class="upload-icon" style="font-size: 2em; margin-bottom: 10px;">📄</div>
                            <div class="upload-text" style="font-size: 0.9em;">Upload Text File</div>
                            <div class="upload-subtext" style="font-size: 0.8em;">.txt, .doc, .docx</div>
                        </div>
                        <input type="file" id="textFileUpload" accept=".txt,.doc,.docx" style="display: none;" onchange="loadTextFile(event)">
                    </div>
                </div>
                
                <div class="text-stats">
                    <div class="text-stat-card">
                        <span class="text-stat-value" id="wordCount">0</span>
                        <div class="text-stat-label">Words</div>
                    </div>
                    <div class="text-stat-card">
                        <span class="text-stat-value" id="charCount">0</span>
                        <div class="text-stat-label">Characters</div>
                    </div>
                    <div class="text-stat-card">
                        <span class="text-stat-value" id="charCountNoSpaces">0</span>
                        <div class="text-stat-label">Characters (no spaces)</div>
                    </div>
                    <div class="text-stat-card">
                        <span class="text-stat-value" id="paragraphCount">0</span>
                        <div class="text-stat-label">Paragraphs</div>
                    </div>
                    <div class="text-stat-card">
                        <span class="text-stat-value" id="sentenceCount">0</span>
                        <div class="text-stat-label">Sentences</div>
                    </div>
                    <div class="text-stat-card">
                        <span class="text-stat-value" id="readingTime">0</span>
                        <div class="text-stat-label">Reading Time (min)</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-primary" onclick="textTransform('uppercase')">UPPERCASE</button>
                    <button class="btn btn-primary" onclick="textTransform('lowercase')">lowercase</button>
                    <button class="btn btn-primary" onclick="textTransform('capitalize')">Capitalize</button>
                    <button class="btn btn-primary" onclick="textTransform('title')">Title Case</button>
                    <button class="btn btn-secondary" onclick="clearText()">Clear Text</button>
                    <button class="btn btn-success" onclick="copyText()">Copy Text</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pricing Modal -->
    <div class="modal" id="pricingModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Choose Your Plan</h2>
                <button onclick="hidePricing()" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">&times;</button>
            </div>
            
            <div class="pricing-grid">
                <div class="pricing-card">
                    <h3>Anonymous</h3>
                    <div class="price">Free</div>
                    <ul class="features">
                        <li>5 files per 24h</li>
                        <li>Single file processing</li>
                        <li>Basic tools access</li>
                        <li>No registration required</li>
                    </ul>
                </div>
                
                <div class="pricing-card">
                    <h3>Free Account</h3>
                    <div class="price">Free</div>
                    <ul class="features">
                        <li>25 files per 24h</li>
                        <li>Batch processing (5 files)</li>
                        <li>All basic tools</li>
                        <li>Simple registration</li>
                    </ul>
                    <button class="btn btn-primary" onclick="alert('Registration coming soon!')">Sign Up Free</button>
                </div>
                
                <div class="pricing-card">
                    <h3>Premium Tier 1</h3>
                    <div class="price">$2.99<span style="font-size: 0.5em;">/month</span></div>
                    <ul class="features">
                        <li>100 files per 24h</li>
                        <li>Batch processing (20 files)</li>
                        <li>Priority processing</li>
                        <li>Advanced features</li>
                    </ul>
                    <button class="btn btn-warning" onclick="alert('Payment integration coming soon!')">Upgrade</button>
                </div>
                
                <div class="pricing-card">
                    <h3>Premium Tier 2</h3>
                    <div class="price">$5.99<span style="font-size: 0.5em;">/month</span></div>
                    <ul class="features">
                        <li>500 files per 24h</li>
                        <li>Batch processing (50 files)</li>
                        <li>Premium support</li>
                        <li>API access</li>
                    </ul>
                    <button class="btn btn-warning" onclick="alert('Payment integration coming soon!')">Upgrade</button>
                </div>
                
                <div class="pricing-card">
                    <h3>Premium Tier 3</h3>
                    <div class="price">$9.99<span style="font-size: 0.5em;">/month</span></div>
                    <ul class="features">
                        <li>2000 files per 24h</li>
                        <li>Batch processing (100 files)</li>
                        <li>White-label options</li>
                        <li>Enterprise features</li>
                    </ul>
                    <button class="btn btn-warning" onclick="alert('Payment integration coming soon!')">Upgrade</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Name Modal -->
    <div class="filename-modal" id="filenameModal">
        <div class="filename-modal-content">
            <h3 id="filenameModalTitle">Save File As</h3>
            <div class="form-group">
                <label class="form-label">File Name</label>
                <input type="text" class="form-control" id="customFileName" placeholder="Enter file name">
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="confirmFileName()">Save</button>
                <button class="btn btn-secondary" onclick="hideFilenameModal()">Cancel</button>
            </div>
        </div>
    </div>

	<!-- Save As Modal -->
    <div class="filename-modal" id="saveAsModal">
        <div class="filename-modal-content" style="max-width: 500px;">
            <h3 id="saveAsTitle">Save File As</h3>
            <div class="form-group">
                <label class="form-label">File Name</label>
                <input type="text" class="form-control" id="saveAsFileName" placeholder="Enter file name">
                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                    Extension will be added automatically based on format
                </div>
            </div>
            <div class="form-group" id="saveAsLocationGroup">
                <label class="form-label">Save Location</label>
                <select class="form-control" id="saveAsLocation">
                    <option value="downloads">Downloads Folder</option>
                    <option value="desktop">Desktop</option>
                    <option value="documents">Documents</option>
                    <option value="custom">Choose Location...</option>
                </select>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="confirmSaveAs()">Save File</button>
                <button class="btn btn-secondary" onclick="hideSaveAsModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
        <div class="processing-content">
            <div class="spinner"></div>
            <h3 id="processingTitle">Processing Files...</h3>
            <p id="processingStatus">Please wait while we process your files</p>
            <div style="margin-top: 20px;">
                <div style="background: #e9ecef; border-radius: 10px; height: 8px;">
                    <div id="processingProgress" style="background: #667eea; height: 100%; border-radius: 10px; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div style="margin-top: 10px; font-size: 0.9em; color: #666;" id="processingDetails">Initializing...</div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script>
        // Global State Management
        let currentTier = 'anonymous';
        let usageData = {
            count: 0,
            resetTime: new Date(Date.now() + 24 * 60 * 60 * 1000).getTime()
        };
        let selectedFiles = {
            pdf: [],
            toPdf: [],
            image: []
        };
        let currentTool = null;
        let batchMode = {
            pdf: 'single',
            toPdf: 'single',
            image: 'single'
        };
        let pendingDownload = null;
        let imageCanvas = null;
        let imageCtx = null;
        let originalImageData = null;
        let currentImageFile = null;
        let fabricCanvas = null;
        let urlDatabase = [];

        // Set PDF.js worker path
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // Tier Configuration
        const tierLimits = {
            anonymous: { daily: 5, batch: 1, name: 'Anonymous User', class: 'tier-anonymous' },
            free: { daily: 25, batch: 5, name: 'Free Account', class: 'tier-free' },
            premium1: { daily: 100, batch: 20, name: 'Premium Tier 1', class: 'tier-premium1' },
            premium2: { daily: 500, batch: 50, name: 'Premium Tier 2', class: 'tier-premium2' },
            premium3: { daily: 2000, batch: 100, name: 'Premium Tier 3', class: 'tier-premium3' }
        };

        // Calculator State
        let calcState = {
            display: '0',
            previousValue: null,
            operation: null,
            waitingForOperand: false,
            history: []
        };

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            loadUsageData();
            updateUsageDisplay();
            setupEventListeners();
            setupDemoMode();
            startTimer();
            updateBatchOptions();
            initializeImageEditor();
        });

        // Initialize Image Editor
        function initializeImageEditor() {
            imageCanvas = document.getElementById('imageCanvas');
            if (imageCanvas) {
                imageCtx = imageCanvas.getContext('2d');
            }
        }

        // Demo Mode Detection
        function setupDemoMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('demo') === 'true') {
                document.getElementById('demoControls').classList.add('active');
                document.getElementById('demoTierSelect').addEventListener('change', function() {
                    currentTier = this.value;
                    updateUsageDisplay();
                    updateBatchOptions();
                });
            }
        }

        // Usage Data Management
        function loadUsageData() {
            if (!usageData.resetTime || new Date().getTime() > usageData.resetTime) {
                resetUsageData();
            }
        }

        function saveUsageData() {
            // In a real application, this would save to a server
        }

        function resetUsageData() {
            usageData = {
                count: 0,
                resetTime: new Date(Date.now() + 24 * 60 * 60 * 1000).getTime()
            };
            saveUsageData();
        }

        function resetUsage() {
            resetUsageData();
            updateUsageDisplay();
            showToast('Usage data reset!', 'success');
        }

        function updateUsageDisplay() {
            const tier = tierLimits[currentTier];
            const usagePercent = Math.min((usageData.count / tier.daily) * 100, 100);
            
            const tierElement = document.getElementById('currentTier');
            tierElement.textContent = tier.name;
            tierElement.className = `current-tier ${tier.class}`;
            
            document.getElementById('usageStats').textContent = `${usageData.count} / ${tier.daily} files used today`;
            
            const fillElement = document.getElementById('usageFill');
            fillElement.style.width = usagePercent + '%';
            fillElement.className = `usage-fill ${
                usagePercent < 70 ? 'usage-green' : 
                usagePercent < 90 ? 'usage-yellow' : 'usage-red'
            }`;
        }

        function canProcessFiles(count) {
            const tier = tierLimits[currentTier];
            return (usageData.count + count) <= tier.daily && count <= tier.batch;
        }

        function incrementUsage(count) {
            usageData.count += count;
            saveUsageData();
            updateUsageDisplay();
        }

        // Timer for usage reset
        function startTimer() {
            setInterval(updateTimer, 60000);
            updateTimer();
        }

        function updateTimer() {
            const now = new Date().getTime();
            const timeLeft = usageData.resetTime - now;
            
            if (timeLeft <= 0) {
                resetUsageData();
                updateUsageDisplay();
                return;
            }
            
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            
            document.getElementById('resetTimer').textContent = `Resets in: ${hours}h ${minutes}m`;
        }

        // Tool Management
        function openTool(toolId) {
            currentTool = toolId;
            document.getElementById(toolId + '-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeTool() {
            if (currentTool) {
                document.getElementById(currentTool + '-modal').classList.remove('active');
                currentTool = null;
                document.body.style.overflow = 'auto';
            }
        }

        // Batch Options Management
        function updateBatchOptions() {
            const tier = tierLimits[currentTier];
            
            ['pdf', 'toPdf', 'image'].forEach(type => {
                const batchOption = document.getElementById(`batch${type.charAt(0).toUpperCase() + type.slice(1)}Option`);
                const batchStatus = document.getElementById(`${type}BatchStatus`);
                const batchDescription = document.getElementById(`${type}BatchDescription`);
                
                if (batchOption && batchStatus) {
                    if (tier.batch > 1) {
                        batchStatus.textContent = 'Available';
                        batchStatus.style.color = '#28a745';
                        batchOption.style.opacity = '1';
                        batchOption.style.cursor = 'pointer';
                    } else {
                        batchStatus.textContent = 'Upgrade Required';
                        batchStatus.style.color = '#dc3545';
                        batchOption.style.opacity = '0.6';
                        batchOption.style.cursor = 'not-allowed';
                    }
                }
                
                if (batchDescription) {
                    batchDescription.textContent = `Batch process multiple files (up to ${tier.batch})`;
                }
            });
        }

        function selectBatchOption(type, mode) {
            const tier = tierLimits[currentTier];
            
            if (mode === 'batch' && tier.batch <= 1) {
                showToast('Batch processing requires a Free Account or Premium subscription', 'warning');
                showPricing();
                return;
            }
            
            batchMode[type] = mode;
            
            document.querySelectorAll(`#${type}BatchOptions .batch-option`).forEach(option => {
                option.classList.remove('selected');
            });
            
            const selectedOption = mode === 'single' ? 
                document.getElementById(`single${type.charAt(0).toUpperCase() + type.slice(1)}Option`) :
                document.getElementById(`batch${type.charAt(0).toUpperCase() + type.slice(1)}Option`);
                
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            const fileInput = document.getElementById(`${type}FileInput`);
            if (fileInput) {
                fileInput.multiple = mode === 'batch';
            }
        }

        // Event Listeners Setup
        function setupEventListeners() {
            ['pdf', 'toPdf', 'image'].forEach(type => {
                const input = document.getElementById(`${type}FileInput`);
                const area = document.getElementById(`${type}UploadArea`);
                
                if (input && area) {
                    input.addEventListener('change', (e) => handleFileSelect(e, type));
                    area.addEventListener('dragover', handleDragOver);
                    area.addEventListener('drop', (e) => handleDrop(e, type));
                    area.addEventListener('dragleave', handleDragLeave);
                }
            });

            document.querySelectorAll('.tool-modal, .modal, .filename-modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        if (this.classList.contains('tool-modal')) {
                            closeTool();
                        } else if (this.id === 'pricingModal') {
                            hidePricing();
                        } else if (this.classList.contains('filename-modal')) {
                            hideFilenameModal();
                        }
                    }
                });
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (document.querySelector('.tool-modal.active')) {
                        closeTool();
                    } else if (document.getElementById('pricingModal').classList.contains('active')) {
                        hidePricing();
                    } else if (document.getElementById('filenameModal').classList.contains('active')) {
                        hideFilenameModal();
                    }
                }
            });

			// Add event listener for Save As modal
            document.getElementById('saveAsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideSaveAsModal();
                }
            });

            // Update the existing escape key handler to include Save As modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (document.querySelector('.tool-modal.active')) {
                        closeTool();
                    } else if (document.getElementById('pricingModal').classList.contains('active')) {
                        hidePricing();
                    } else if (document.getElementById('filenameModal').classList.contains('active')) {
                        hideFilenameModal();
                    } else if (document.getElementById('saveAsModal').classList.contains('active')) {
                        hideSaveAsModal();
                    }
                }
            });
        }

        // File Handling
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e, type) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFileSelect({ target: { files } }, type);
        }

        function handleFileSelect(e, type) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            const tier = tierLimits[currentTier];
            const currentCount = selectedFiles[type].length;
            const maxFiles = batchMode[type] === 'single' ? 1 : tier.batch;
            
            if (batchMode[type] === 'single' && files.length > 1) {
                showToast('Single file mode selected. Please choose one file only.', 'warning');
                return;
            }

            if (currentCount + files.length > maxFiles) {
                showToast(`Maximum ${maxFiles} files allowed in current mode.`, 'error');
                return;
            }

            selectedFiles[type] = batchMode[type] === 'single' ? files : [...selectedFiles[type], ...files];
            updateFileList(type);
            
            if (type === 'image' && files.length > 0) {
                loadImageForPreview(files[0]);
            }
            
            e.target.value = '';
        }

        function updateFileList(type) {
            const listElement = document.getElementById(`${type}FileList`);
            if (!listElement) return;

            if (selectedFiles[type].length === 0) {
                listElement.style.display = 'none';
                return;
            }

            listElement.style.display = 'block';
            listElement.innerHTML = selectedFiles[type].map((file, index) => `
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-icon">📄</div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-secondary" onclick="removeFile('${type}', ${index})" 
                                style="padding: 5px 10px; font-size: 0.8em;">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function removeFile(type, index) {
            selectedFiles[type].splice(index, 1);
            updateFileList(type);
        }

        function clearFiles(type) {
            selectedFiles[type] = [];
            updateFileList(type);
            document.getElementById(`${type}FileInput`).value = '';
            
            if (type === 'image') {
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('downloadImageBtn').style.display = 'none';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

		// Call this when user clicks 'X' or presses ESC on processing modal
function onProcessingModalClose() {
    cancelPdfProcessing();
}

// Global variables for PDF processing
let combineMode = 'combine'; // 'combine' or 'separate'
let pendingSaveCallback = null;
let isProcessingCancelled = false; // Add this new global variable

// Update batch option selection to show/hide combine options
function selectBatchOption(type, mode) {
    const tier = tierLimits[currentTier];
    
    if (mode === 'batch' && tier.batch <= 1) {
        showToast('Batch processing requires a Free Account or Premium subscription', 'warning');
        showPricing();
        return;
    }
    
    batchMode[type] = mode;
    
    document.querySelectorAll(`#${type}BatchOptions .batch-option`).forEach(option => {
        if (!option.id.includes('combine') && !option.id.includes('separate')) {
            option.classList.remove('selected');
        }
    });
    
    const selectedOption = mode === 'single' ? 
        document.getElementById(`single${type.charAt(0).toUpperCase() + type.slice(1)}Option`) :
        document.getElementById(`batch${type.charAt(0).toUpperCase() + type.slice(1)}Option`);
        
    if (selectedOption) {
        selectedOption.classList.add('selected');
    }
    
    // Show/hide batch processing options
    const batchProcessingOptions = document.getElementById('batchProcessingOptions');
    if (type === 'pdf' && batchProcessingOptions) {
        if (mode === 'batch') {
            batchProcessingOptions.style.display = 'block';
        } else {
            batchProcessingOptions.style.display = 'none';
        }
    }
    
    const fileInput = document.getElementById(`${type}FileInput`);
    if (fileInput) {
        fileInput.multiple = mode === 'batch';
    }
}

// Select combine option for batch processing
function selectCombineOption(mode) {
    combineMode = mode;
    document.querySelectorAll('input[name="combineMode"]').forEach(radio => {
        radio.checked = radio.value === mode;
    });
    
    document.querySelectorAll('#batchProcessingOptions .batch-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    const selectedOption = mode === 'combine' ? 
        document.getElementById('combineOption') : 
        document.getElementById('separateOption');
    if (selectedOption) {
        selectedOption.classList.add('selected');
    }
}

// Enhanced PDF Converter Functions with Save As Dialog
async function convertPdfToFormat() {
    const files = selectedFiles.pdf;
    if (files.length === 0) {
        showToast('Please select PDF files to convert', 'error');
        return;
    }

    if (!canProcessFiles(files.length)) {
        const tier = tierLimits[currentTier];
        showToast(`Usage limit exceeded! Your tier allows ${tier.daily} files per day and ${tier.batch} files per batch.`, 'error');
        return;
    }

    const outputFormat = document.getElementById('pdfOutputFormat').value;
    const detectTables = document.getElementById('detectTables').checked;
    
    // Reset cancellation flag
    isProcessingCancelled = false;
    
    showProcessing('Converting PDF...', 'Processing your PDF files with advanced table detection');
    
    try {
        if (batchMode.pdf === 'batch' && files.length > 1) {
            if (combineMode === 'combine') {
                // Combine all PDFs into one output file
                await processCombinedPdfs(files, outputFormat, detectTables);
            } else {
                // Process each PDF separately
                await processSeparatePdfs(files, outputFormat, detectTables);
            }
        } else {
            // Single file processing
            await processSeparatePdfs(files, outputFormat, detectTables);
        }

        if (!isProcessingCancelled) {
            incrementUsage(files.length);
            hideProcessing();
            showToast('PDF conversion completed!', 'success');
            clearFiles('pdf');
        }
        
    } catch (error) {
        console.error('PDF conversion error:', error);
        if (!isProcessingCancelled) {
            hideProcessing();
            showToast('Error converting PDF. Please try again.', 'error');
        }
    }
}

// Process multiple PDFs as separate files
async function processSeparatePdfs(files, outputFormat, detectTables) {
    for (let i = 0; i < files.length; i++) {
        // Check if processing was cancelled
        if (isProcessingCancelled) {
            return;
        }
        
        const file = files[i];
        updateProcessingProgress(i, files.length, `Processing ${file.name}...`);
        
        const defaultName = file.name.replace('.pdf', '');
        const extension = getExtensionForFormat(outputFormat);
        
        await new Promise((resolve) => {
            // Check if processing was cancelled before showing save dialog
            if (isProcessingCancelled) {
                resolve();
                return;
            }
            
            showSaveAsModal(
                `Save ${outputFormat.toUpperCase()} File`, 
                defaultName, 
                async (fileName, location) => {
                    try {
                        // Check if processing was cancelled during save dialog
                        if (isProcessingCancelled) {
                            resolve();
                            return;
                        }
                        
                        const extractedData = await extractPdfData(file, detectTables);
                        
                        // Check again after extraction
                        if (!isProcessingCancelled) {
                            await downloadProcessedFile(extractedData, fileName + extension, outputFormat, location);
                        }
                        resolve();
                    } catch (error) {
                        console.error('Error converting PDF:', error);
                        if (!isProcessingCancelled) {
                            showToast(`Error processing ${file.name}`, 'error');
                        }
                        resolve();
                    }
                }
            );
        });
    }
}

// Process multiple PDFs as one combined file
async function processCombinedPdfs(files, outputFormat, detectTables) {
    updateProcessingProgress(0, 1, 'Combining PDF files...');
    
    const combinedData = [];
    let allTables = [];
    
    for (let i = 0; i < files.length; i++) {
        // Check if processing was cancelled
        if (isProcessingCancelled) {
            return;
        }
        
        const file = files[i];
        updateProcessingProgress(i, files.length, `Processing ${file.name}...`);
        
        const extractedData = await extractPdfData(file, detectTables);
        
        // Check again after extraction
        if (isProcessingCancelled) {
            return;
        }
        
        combinedData.push(...extractedData);
        
        // Collect all tables if table detection is enabled
        if (detectTables) {
            extractedData.forEach(page => {
                if (page.tables && page.tables.length > 0) {
                    allTables.push(...page.tables);
                }
            });
        }
    }
    
    // Check if processing was cancelled before showing save dialog
    if (isProcessingCancelled) {
        return;
    }
    
    const defaultName = `combined_pdfs_${Date.now()}`;
    const extension = getExtensionForFormat(outputFormat);
    
    await new Promise((resolve) => {
        showSaveAsModal(
            `Save Combined ${outputFormat.toUpperCase()} File`, 
            defaultName, 
            async (fileName, location) => {
                try {
                    // Check if processing was cancelled during save dialog
                    if (!isProcessingCancelled) {
                        await downloadProcessedFile(combinedData, fileName + extension, outputFormat, location, allTables);
                    }
                    resolve();
                } catch (error) {
                    console.error('Error creating combined file:', error);
                    if (!isProcessingCancelled) {
                        showToast('Error creating combined file', 'error');
                    }
                    resolve();
                }
            }
        );
    });
}

// Extract data from PDF using PDF.js
async function extractPdfData(file, detectTables) {
    // Check if processing was cancelled before starting
    if (isProcessingCancelled) {
        throw new Error('Processing cancelled');
    }
    
    if (typeof pdfjsLib === 'undefined') {
        throw new Error('PDF.js library not loaded');
    }

    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
    
    let extractedData = [];
    
    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        // Check if processing was cancelled during page processing
        if (isProcessingCancelled) {
            throw new Error('Processing cancelled');
        }
        
        const page = await pdf.getPage(pageNum);
        const textContent = await page.getTextContent();
        
        let pageText = '';
        let tables = [];
        
        if (detectTables) {
            const tableData = detectTablesInPage(textContent);
            tables = tableData.tables;
            pageText = tableData.remainingText;
        } else {
            pageText = textContent.items.map(item => item.str).join(' ');
        }
        
        extractedData.push({
            page: pageNum,
            text: pageText,
            tables: tables,
            fileName: file.name,
            items: textContent.items
        });
    }
    
    return extractedData;
}

// Enhanced table detection function
function detectTablesInPage(textContent) {
    const items = textContent.items;
    const tables = [];
    const remainingText = [];

    // Group items by y-coordinate (rows)
    const rowGroups = {};
    items.forEach(item => {
        const y = Math.round(item.transform[5] / 2) * 2; // Group nearby y-coordinates
        if (!rowGroups[y]) rowGroups[y] = [];
        rowGroups[y].push(item);
    });

    // Sort rows by y-coordinate (top to bottom)
    const sortedRows = Object.keys(rowGroups).sort((a, b) => b - a).map(y => rowGroups[y]);

    // Detect table patterns
    const tableRows = [];
    const nonTableRows = [];
    
    for (const row of sortedRows) {
        const sortedRowItems = row.sort((a, b) => a.transform[4] - b.transform[4]);
        
        if (sortedRowItems.length >= 2) {
            // Calculate spacing between items
            const spacings = [];
            for (let j = 1; j < sortedRowItems.length; j++) {
                spacings.push(sortedRowItems[j].transform[4] - sortedRowItems[j-1].transform[4]);
            }
            
            const avgSpacing = spacings.reduce((a, b) => a + b, 0) / spacings.length;
            const isConsistentSpacing = spacings.every(s => Math.abs(s - avgSpacing) < avgSpacing * 0.6);
            
            if (isConsistentSpacing && sortedRowItems.length >= 2 && avgSpacing > 20) {
                const cleanRow = sortedRowItems.map(item => item.str.trim()).filter(str => str);
                if (cleanRow.length >= 2) {
                    tableRows.push(cleanRow);
                } else {
                    nonTableRows.push(sortedRowItems.map(item => item.str).join(' '));
                }
            } else {
                nonTableRows.push(sortedRowItems.map(item => item.str).join(' '));
            }
        } else {
            nonTableRows.push(row.map(item => item.str).join(' '));
        }
    }

    // Group consecutive table rows
    if (tableRows.length > 0) {
        let currentTable = [];
        let expectedColumns = tableRows[0].length;
        
        for (const row of tableRows) {
            if (Math.abs(row.length - expectedColumns) <= 1) {
                currentTable.push(row);
            } else {
                if (currentTable.length >= 2) {
                    tables.push(currentTable);
                }
                currentTable = [row];
                expectedColumns = row.length;
            }
        }
        
        if (currentTable.length >= 2) {
            tables.push(currentTable);
        }
    }

    return {
        tables: tables,
        remainingText: nonTableRows.join('\n').trim()
    };
}

// Download processed file with format-specific handling
async function downloadProcessedFile(data, filename, format, location, allTables = null) {
    // Check if processing was cancelled before creating file
    if (isProcessingCancelled) {
        return;
    }
    
    let blob;
    
    switch (format) {
        case 'txt':
            const textContent = data.map(page => {
                let content = `--- Page ${page.page} ---\n${page.text}`;
                if (page.fileName) content = `--- ${page.fileName} - Page ${page.page} ---\n${page.text}`;
                return content;
            }).join('\n\n');
            blob = new Blob([textContent], { type: 'text/plain' });
            break;
            
        case 'csv':
            let csvContent = '';
            const tables = allTables || data.flatMap(page => page.tables || []);
            
            if (tables.length > 0) {
                tables.forEach((table, tableIndex) => {
                    if (tableIndex > 0) csvContent += '\n';
                    csvContent += `"Table ${tableIndex + 1}"\n`;
                    
                    table.forEach(row => {
                        const escapedRow = row.map(cell => `"${String(cell).replace(/"/g, '""')}"`);
                        csvContent += escapedRow.join(',') + '\n';
                    });
                    csvContent += '\n';
                });
            } else {
                csvContent = 'Source,Page,Content\n';
                data.forEach(page => {
                    const source = page.fileName || 'PDF';
                    const escapedText = page.text.replace(/"/g, '""');
                    csvContent += `"${source}",${page.page},"${escapedText}"\n`;
                });
            }
            blob = new Blob([csvContent], { type: 'text/csv' });
            break;
            
        case 'json':
            const jsonData = {
                extractedAt: new Date().toISOString(),
                totalPages: data.length,
                files: data.reduce((acc, page) => {
                    const fileName = page.fileName || 'unknown.pdf';
                    if (!acc[fileName]) {
                        acc[fileName] = { pages: [], tables: [] };
                    }
                    acc[fileName].pages.push({
                        pageNumber: page.page,
                        text: page.text,
                        wordCount: page.text.split(/\s+/).length
                    });
                    if (page.tables) {
                        acc[fileName].tables.push(...page.tables);
                    }
                    return acc;
                }, {}),
                tables: allTables || data.flatMap(page => page.tables || [])
            };
            blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            break;
            
        case 'docx':
            // Simple Word document creation
            const wordContent = data.map(page => {
                let content = `Page ${page.page}\n${page.text}`;
                if (page.fileName) content = `${page.fileName} - Page ${page.page}\n${page.text}`;
                return content;
            }).join('\n\n');
            
            blob = new Blob([wordContent], { 
                type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' 
            });
            break;
            
        default:
            throw new Error('Unsupported format');
    }
    
    // Final check before download
    if (!isProcessingCancelled) {
        downloadBlob(blob, filename);
    }
}

function getExtensionForFormat(format) {
    const extensions = {
        'txt': '.txt',
        'docx': '.docx',
        'csv': '.csv',
        'json': '.json'
    };
    return extensions[format] || '.txt';
}

// Save As Modal Functions
function showSaveAsModal(title, defaultName, callback) {
    // Don't show save dialog if processing was cancelled
    if (isProcessingCancelled) {
        return;
    }
    
    document.getElementById('saveAsTitle').textContent = title;
    document.getElementById('saveAsFileName').value = defaultName;
    document.getElementById('saveAsModal').classList.add('active');
    pendingSaveCallback = callback;
}

function hideSaveAsModal() {
    document.getElementById('saveAsModal').classList.remove('active');
    pendingSaveCallback = null;
}

function confirmSaveAs() {
    const fileName = document.getElementById('saveAsFileName').value.trim();
    const location = document.getElementById('saveAsLocation').value;
    
    if (!fileName) {
        showToast('Please enter a file name', 'error');
        return;
    }
    
    if (pendingSaveCallback) {
        pendingSaveCallback(fileName, location);
    }
    hideSaveAsModal();
}

// Enhanced downloadBlob function with location awareness
function downloadBlob(blob, filename) {
    // Don't download if processing was cancelled
    if (isProcessingCancelled) {
        return;
    }
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Add this new function to handle cancellation
function cancelPdfProcessing() {
    isProcessingCancelled = true;
    hideProcessing();
    hideSaveAsModal();
    showToast('PDF conversion cancelled', 'info');
}

        // Convert to PDF Functions
        async function convertToPdf() {
            const files = selectedFiles.toPdf;
            if (files.length === 0) {
                showToast('Please select files to convert to PDF', 'error');
                return;
            }

            if (!canProcessFiles(files.length)) {
                const tier = tierLimits[currentTier];
                showToast(`Usage limit exceeded! Your tier allows ${tier.daily} files per day and ${tier.batch} files per batch.`, 'error');
                return;
            }

            showProcessing('Converting to PDF...', 'Processing your files');

            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    updateProcessingProgress(i, files.length, `Converting ${file.name}...`);

                    const defaultName = file.name.replace(/\.[^/.]+$/, "");
                    
                    await new Promise((resolve) => {
                        showFilenameModal(`Save PDF as`, defaultName, async (customName) => {
                            try {
                                if (file.type.startsWith('image/')) {
                                    await convertImageToPdf(file, customName);
                                } else if (file.type.includes('text/plain')) {
                                    await convertTextToPdf(file, customName);
                                } else if (file.type.includes('word') || file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                                    await convertDocToPdf(file, customName);
                                }
                                resolve();
                            } catch (error) {
                                console.error('Error converting file:', error);
                                showToast(`Error converting ${file.name}`, 'error');
                                resolve();
                            }
                        });
                    });
                }

                incrementUsage(files.length);
                hideProcessing();
                showToast(`Successfully converted ${files.length} file(s) to PDF!`, 'success');
                clearFiles('toPdf');
                
            } catch (error) {
                console.error('PDF conversion error:', error);
                hideProcessing();
                showToast('Error converting files. Please try again.', 'error');
            }
        }

        async function convertImageToPdf(file, customName) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF();
                        
                        const img = new Image();
                        img.onload = function() {
                            const pageWidth = pdf.internal.pageSize.getWidth();
                            const pageHeight = pdf.internal.pageSize.getHeight();
                            const imgRatio = img.width / img.height;
                            const pageRatio = pageWidth / pageHeight;
                            
                            let width, height;
                            if (imgRatio > pageRatio) {
                                width = pageWidth - 20;
                                height = width / imgRatio;
                            } else {
                                height = pageHeight - 20;
                                width = height * imgRatio;
                            }
                            
                            const x = (pageWidth - width) / 2;
                            const y = (pageHeight - height) / 2;
                            
                            pdf.addImage(e.target.result, 'JPEG', x, y, width, height);
                            pdf.save(`${customName}.pdf`);
                            resolve();
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function convertTextToPdf(file, customName) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF();
                        
                        const text = e.target.result;
                        const lines = pdf.splitTextToSize(text, 180);
                        
                        let y = 20;
                        const lineHeight = 7;
                        const pageHeight = pdf.internal.pageSize.getHeight();
                        
                        for (let line of lines) {
                            if (y + lineHeight > pageHeight - 20) {
                                pdf.addPage();
                                y = 20;
                            }
                            pdf.text(line, 10, y);
                            y += lineHeight;
                        }
                        
                        pdf.save(`${customName}.pdf`);
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        async function convertDocToPdf(file, customName) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        if (typeof mammoth !== 'undefined') {
                            const result = await mammoth.extractRawText({arrayBuffer: e.target.result});
                            const text = result.value;
                            
                            const { jsPDF } = window.jspdf;
                            const pdf = new jsPDF();
                            const lines = pdf.splitTextToSize(text, 180);
                            
                            let y = 20;
                            const lineHeight = 7;
                            const pageHeight = pdf.internal.pageSize.getHeight();
                            
                            for (let line of lines) {
                                if (y + lineHeight > pageHeight - 20) {
                                    pdf.addPage();
                                    y = 20;
                                }
                                pdf.text(line, 10, y);
                                y += lineHeight;
                            }
                            
                            pdf.save(`${customName}.pdf`);
                            resolve();
                        } else {
                            reject(new Error('Word document processing not available'));
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Enhanced Image Processing Functions
        function loadImageForPreview(file) {
            currentImageFile = file;
            
            // Check if it's a Live Photo (HEIC)
            if (file.name.toLowerCase().endsWith('.heic')) {
                showToast('Live Photo detected! Use "Live Photo → GIF" feature for conversion.', 'info');
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    imageCanvas.width = img.width;
                    imageCanvas.height = img.height;
                    imageCtx.drawImage(img, 0, 0);
                    
                    originalImageData = imageCtx.getImageData(0, 0, img.width, img.height);
                    
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('downloadImageBtn').style.display = 'inline-block';
                    resetFilters();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function applyFilters() {
            if (!originalImageData) return;
            
            const brightness = parseInt(document.getElementById('brightness').value);
            const contrast = parseInt(document.getElementById('contrast').value);
            const saturation = parseInt(document.getElementById('saturation').value);
            const blur = parseInt(document.getElementById('blur').value);
            const hue = parseInt(document.getElementById('hueRotate').value);
            
            imageCtx.putImageData(originalImageData, 0, 0);
            
            let filters = [];
            if (brightness !== 0) filters.push(`brightness(${100 + brightness}%)`);
            if (contrast !== 0) filters.push(`contrast(${100 + contrast}%)`);
            if (saturation !== 0) filters.push(`saturate(${100 + saturation}%)`);
            if (blur > 0) filters.push(`blur(${blur}px)`);
            if (hue !== 0) filters.push(`hue-rotate(${hue}deg)`);
            
            imageCanvas.style.filter = filters.join(' ');
        }

        function applyPresetFilter(filterType) {
            if (!originalImageData) return;
            
            resetFilters();
            
            switch (filterType) {
                case 'grayscale':
                    imageCanvas.style.filter = 'grayscale(100%)';
                    break;
                case 'sepia':
                    imageCanvas.style.filter = 'sepia(100%)';
                    break;
                case 'vintage':
                    imageCanvas.style.filter = 'sepia(50%) contrast(120%) brightness(110%)';
                    break;
                case 'invert':
                    imageCanvas.style.filter = 'invert(100%)';
                    break;
                case 'warm':
                    imageCanvas.style.filter = 'sepia(20%) saturate(120%) hue-rotate(15deg)';
                    break;
                case 'cool':
                    imageCanvas.style.filter = 'hue-rotate(180deg) saturate(120%)';
                    break;
            }
        }

        function resetFilters() {
            document.getElementById('brightness').value = 0;
            document.getElementById('contrast').value = 0;
            document.getElementById('saturation').value = 0;
            document.getElementById('blur').value = 0;
            document.getElementById('hueRotate').value = 0;
            document.getElementById('brightnessValue').textContent = 0;
            document.getElementById('contrastValue').textContent = 0;
            document.getElementById('saturationValue').textContent = 0;
            document.getElementById('blurValue').textContent = 0;
            document.getElementById('hueValue').textContent = 0;
            
            if (imageCanvas) {
                imageCanvas.style.filter = 'none';
            }
        }

        function addTextOverlay() {
            const text = document.getElementById('overlayText').value;
            const fontSize = document.getElementById('fontSize').value;
            const textColor = document.getElementById('textColor').value;
            const bgColor = document.getElementById('textBgColor').value;
            
            if (!text || !imageCanvas) {
                showToast('Please enter text and select an image', 'error');
                return;
            }
            
            imageCtx.font = `${fontSize}px Arial`;
            imageCtx.fillStyle = bgColor;
            
            const textWidth = imageCtx.measureText(text).width;
            const textHeight = parseInt(fontSize);
            const x = (imageCanvas.width - textWidth) / 2;
            const y = imageCanvas.height - 50;
            
            // Draw background
            imageCtx.fillRect(x - 10, y - textHeight, textWidth + 20, textHeight + 10);
            
            // Draw text
            imageCtx.fillStyle = textColor;
            imageCtx.fillText(text, x, y);
            
            showToast('Text overlay added!', 'success');
        }

        function removeBackground() {
            showToast('Background removal feature uses advanced AI algorithms. Results may vary.', 'warning');
            
            if (!currentImageFile) {
                showToast('Please select an image first', 'error');
                return;
            }
            
            setTimeout(() => {
                const imageData = imageCtx.getImageData(0, 0, imageCanvas.width, imageCanvas.height);
                const data = imageData.data;
                
                // Simple background removal algorithm
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // Detect background (assuming it's light colored)
                    const avg = (r + g + b) / 3;
                    if (avg > 200) {
                        data[i + 3] = 0; // Make transparent
                    }
                }
                
                imageCtx.putImageData(imageData, 0, 0);
                showToast('Background removal completed!', 'success');
            }, 1000);
        }

        function compressImage() {
            if (!currentImageFile) {
                showToast('Please select an image first', 'error');
                return;
            }
            
            const quality = 0.7; // 70% quality
            imageCanvas.toBlob(function(blob) {
                const originalSize = currentImageFile.size;
                const newSize = blob.size;
                const reduction = Math.round((1 - newSize/originalSize) * 100);
                
                showToast(`Image compressed by ${reduction}%! Original: ${formatFileSize(originalSize)} → New: ${formatFileSize(newSize)}`, 'success');
            }, 'image/jpeg', quality);
        }

        function resizeImage() {
            if (!currentImageFile) {
                showToast('Please select an image first', 'error');
                return;
            }
            
            const newWidth = prompt('Enter new width (pixels):', imageCanvas.width);
            const newHeight = prompt('Enter new height (pixels):', imageCanvas.height);
            
            if (newWidth && newHeight) {
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCanvas.width = parseInt(newWidth);
                tempCanvas.height = parseInt(newHeight);
                
                tempCtx.drawImage(imageCanvas, 0, 0, parseInt(newWidth), parseInt(newHeight));
                
                imageCanvas.width = parseInt(newWidth);
                imageCanvas.height = parseInt(newHeight);
                imageCtx.drawImage(tempCanvas, 0, 0);
                
                showToast('Image resized successfully!', 'success');
            }
        }

        function cropImage() {
            if (!currentImageFile) {
                showToast('Please select an image first', 'error');
                return;
            }
            
            const x = parseInt(prompt('Enter X coordinate to start crop:', 0));
            const y = parseInt(prompt('Enter Y coordinate to start crop:', 0));
            const width = parseInt(prompt('Enter crop width:', imageCanvas.width / 2));
            const height = parseInt(prompt('Enter crop height:', imageCanvas.height / 2));
            
            if (!isNaN(x) && !isNaN(y) && !isNaN(width) && !isNaN(height)) {
                const imageData = imageCtx.getImageData(x, y, width, height);
                imageCanvas.width = width;
                imageCanvas.height = height;
                imageCtx.putImageData(imageData, 0, 0);
                
                showToast('Image cropped successfully!', 'success');
            }
        }

        function convertLivePhotoToGif() {
            if (!currentImageFile) {
                showToast('Please select a Live Photo first', 'error');
                return;
            }
            
            if (!currentImageFile.name.toLowerCase().endsWith('.heic')) {
                showToast('This feature is for Live Photos (.heic files)', 'warning');
                return;
            }
            
            showToast('Live Photo to GIF conversion is experimental. Processing...', 'info');
            
            // Simulate Live Photo to GIF conversion
            setTimeout(() => {
                // Create a simple animated GIF from the static image
                const frames = [];
                const originalFilter = imageCanvas.style.filter;
                
                // Create multiple frames with slight variations
                for (let i = 0; i < 10; i++) {
                    const brightness = Math.sin(i * 0.2) * 20;
                    imageCanvas.style.filter = `brightness(${100 + brightness}%)`;
                    
                    const frameCanvas = document.createElement('canvas');
                    frameCanvas.width = imageCanvas.width;
                    frameCanvas.height = imageCanvas.height;
                    const frameCtx = frameCanvas.getContext('2d');
                    frameCtx.drawImage(imageCanvas, 0, 0);
                    
                    frames.push(frameCanvas.toDataURL());
                }
                
                imageCanvas.style.filter = originalFilter;
                
                // Download as individual frames (real GIF creation would need additional libraries)
                frames.forEach((frame, index) => {
                    const a = document.createElement('a');
                    a.href = frame;
                    a.download = `live_photo_frame_${index + 1}.png`;
                    a.click();
                });
                
                showToast('Live Photo frames extracted! Combine them using a GIF creator.', 'success');
            }, 2000);
        }

        function removeWatermark() {
            if (!currentImageFile) {
                showToast('Please select an image first', 'error');
                return;
            }
            
            showToast('Watermark removal is experimental and works best with simple, uniform watermarks.', 'warning');
            
            setTimeout(() => {
                const imageData = imageCtx.getImageData(0, 0, imageCanvas.width, imageCanvas.height);
                const data = imageData.data;
                
                // Advanced watermark removal algorithm
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const a = data[i + 3];
                    
                    // Detect semi-transparent pixels (common in watermarks)
                    if (a < 255 && a > 50) {
                        // Try to reconstruct the background
                        data[i] = Math.min(255, r * 1.2);
                        data[i + 1] = Math.min(255, g * 1.2);
                        data[i + 2] = Math.min(255, b * 1.2);
                        data[i + 3] = 255;
                    }
                }
                
                imageCtx.putImageData(imageData, 0, 0);
                showToast('Watermark removal attempt completed. Results may vary.', 'success');
            }, 1500);
        }

        async function processImages() {
            const files = selectedFiles.image;
            if (files.length === 0) {
                showToast('Please select images to process', 'error');
                return;
            }

            if (!canProcessFiles(files.length)) {
                const tier = tierLimits[currentTier];
                showToast(`Usage limit exceeded! Your tier allows ${tier.daily} files per day and ${tier.batch} files per batch.`, 'error');
                return;
            }

            const targetFormat = document.getElementById('imageFormat').value;
            const quality = document.getElementById('imageQuality').value / 100;

            showProcessing('Processing Images...', 'Applying filters and converting');

            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    updateProcessingProgress(i, files.length, `Processing ${file.name}...`);
                    
                    const defaultName = file.name.replace(/\.[^/.]+$/, "");
                    
                    await new Promise((resolve) => {
                        showFilenameModal(`Save ${targetFormat.toUpperCase()} as`, defaultName, async (customName) => {
                            try {
                                await convertSingleImage(file, targetFormat, quality, customName);
                                resolve();
                            } catch (error) {
                                console.error('Error processing image:', error);
                                showToast(`Error processing ${file.name}`, 'error');
                                resolve();
                            }
                        });
                    });
                }

                incrementUsage(files.length);
                hideProcessing();
                showToast(`Successfully processed ${files.length} image(s)!`, 'success');
                clearFiles('image');
                
            } catch (error) {
                console.error('Image processing error:', error);
                hideProcessing();
                showToast('Error processing images. Please try again.', 'error');
            }
        }

        function downloadProcessedImage() {
            if (!imageCanvas) {
                showToast('No processed image to download', 'error');
                return;
            }
            
            const format = document.getElementById('imageFormat').value;
            const quality = document.getElementById('imageQuality').value / 100;
            const mimeType = `image/${format === 'jpg' ? 'jpeg' : format}`;
            
            imageCanvas.toBlob(function(blob) {
                const filename = `processed_image.${format}`;
                downloadBlob(blob, filename);
                showToast('Image downloaded successfully!', 'success');
            }, mimeType, format === 'jpg' || format === 'webp' ? quality : undefined);
        }

        async function convertSingleImage(file, targetFormat, quality, customName) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    const mimeType = `image/${targetFormat === 'jpg' ? 'jpeg' : targetFormat}`;
                    
                    canvas.toBlob(function(blob) {
                        const filename = `${customName}.${targetFormat}`;
                        downloadBlob(blob, filename);
                        resolve();
                    }, mimeType, targetFormat === 'jpg' || targetFormat === 'webp' ? quality : undefined);
                };
                
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // URL Shortener Functions
        function generateShortCode(length = 6) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function createShortUrl() {
            const originalUrl = document.getElementById('originalUrl').value;
            const customCode = document.getElementById('customCode').value;
            const password = document.getElementById('linkPassword').value;
            const expiration = document.getElementById('linkExpiration').value;
            
            if (!originalUrl) {
                showToast('Please enter a URL to shorten', 'error');
                return;
            }
            
            if (!originalUrl.startsWith('http://') && !originalUrl.startsWith('https://')) {
                showToast('Please enter a valid URL starting with http:// or https://', 'error');
                return;
            }
            
            const shortCode = customCode || generateShortCode();
            const shortUrl = `https://utilihub.short/${shortCode}`;
            
            // Store in our "database"
            const urlEntry = {
                id: Date.now(),
                originalUrl: originalUrl,
                shortCode: shortCode,
                shortUrl: shortUrl,
                password: password,
                expiration: expiration ? new Date(Date.now() + parseInt(expiration) * 24 * 60 * 60 * 1000) : null,
                created: new Date(),
                clicks: 0,
                uniqueClicks: 0,
                todayClicks: 0,
                weekClicks: 0,
                lastClick: null
            };
            
            urlDatabase.push(urlEntry);
            
            document.getElementById('shortUrl').textContent = shortUrl;
            document.getElementById('urlDisplay').classList.add('show');
            
            showToast('Short URL created successfully!', 'success');
        }

        function copyShortUrl() {
            const shortUrl = document.getElementById('shortUrl').textContent;
            navigator.clipboard.writeText(shortUrl).then(() => {
                showToast('Short URL copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy URL', 'error');
            });
        }

        function showAnalytics() {
            const shortUrl = document.getElementById('shortUrl').textContent;
            const urlEntry = urlDatabase.find(entry => entry.shortUrl === shortUrl);
            
            if (urlEntry) {
                document.getElementById('totalClicks').textContent = urlEntry.clicks;
                document.getElementById('uniqueClicks').textContent = urlEntry.uniqueClicks;
                document.getElementById('todayClicks').textContent = urlEntry.todayClicks;
                document.getElementById('weekClicks').textContent = urlEntry.weekClicks;
                
                document.getElementById('analyticsDisplay').classList.add('show');
                showToast('Analytics data loaded!', 'success');
            } else {
                showToast('No analytics data found', 'error');
            }
        }

        // QR Code Generator Functions
        function updateQrInputs() {
            const qrType = document.getElementById('qrType').value;
            const inputsContainer = document.getElementById('qrInputs');
            
            let inputHtml = '';
            
            switch (qrType) {
                case 'url':
                    inputHtml = `
                        <div class="form-group">
                            <label class="form-label">URL</label>
                            <input type="url" class="form-control" id="qrUrl" placeholder="https://example.com">
                        </div>
                    `;
                    break;
                case 'text':
                    inputHtml = `
                        <div class="form-group">
                            <label class="form-label">Text</label>
                            <textarea class="form-control" id="qrText" rows="3" placeholder="Enter your text"></textarea>
                        </div>
                    `;
                    break;
                case 'email':
                    inputHtml = `
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="qrEmail" placeholder="contact@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subject (Optional)</label>
                            <input type="text" class="form-control" id="qrEmailSubject" placeholder="Email subject">
                        </div>
                    `;
                    break;
                case 'phone':
                    inputHtml = `
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="qrPhone" placeholder="+1234567890">
                        </div>
                    `;
                    break;
                case 'sms':
                    inputHtml = `
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="qrSmsPhone" placeholder="+1234567890">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Message</label>
                            <textarea class="form-control" id="qrSmsMessage" rows="3" placeholder="SMS message"></textarea>
                        </div>
                    `;
                    break;
                case 'wifi':
                    inputHtml = `
                        <div class="form-group">
                            <label class="form-label">Network Name (SSID)</label>
                            <input type="text" class="form-control" id="qrWifiSsid" placeholder="WiFi Network Name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="qrWifiPassword" placeholder="WiFi Password">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Security Type</label>
                            <select class="form-control" id="qrWifiSecurity">
                                <option value="WPA">WPA/WPA2</option>
                                <option value="WEP">WEP</option>
                                <option value="nopass">None</option>
                            </select>
                        </div>
                    `;
                    break;
                case 'vcard':
                    inputHtml = `
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="qrVcardName" placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="qrVcardPhone" placeholder="+1234567890">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="qrVcardEmail" placeholder="john@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company</label>
                            <input type="text" class="form-control" id="qrVcardCompany" placeholder="Company Name">
                        </div>
                    `;
                    break;
            }
            
            inputsContainer.innerHTML = inputHtml;
        }

        function generateQrCode() {
            const qrType = document.getElementById('qrType').value;
            const size = parseInt(document.getElementById('qrSize').value);
            const errorLevel = document.getElementById('qrErrorLevel').value;
            const foreground = document.getElementById('qrForeground').value;
            const background = document.getElementById('qrBackground').value;
            
            let qrData = '';
            
            // Build QR data based on type
            switch (qrType) {
                case 'url':
                    qrData = document.getElementById('qrUrl')?.value || '';
                    break;
                case 'text':
                    qrData = document.getElementById('qrText')?.value || '';
                    break;
                case 'email':
                    const email = document.getElementById('qrEmail')?.value || '';
                    const subject = document.getElementById('qrEmailSubject')?.value || '';
                    qrData = `mailto:${email}${subject ? `?subject=${encodeURIComponent(subject)}` : ''}`;
                    break;
                case 'phone':
                    qrData = `tel:${document.getElementById('qrPhone')?.value || ''}`;
                    break;
                case 'sms':
                    const smsPhone = document.getElementById('qrSmsPhone')?.value || '';
                    const smsMessage = document.getElementById('qrSmsMessage')?.value || '';
                    qrData = `sms:${smsPhone}${smsMessage ? `?body=${encodeURIComponent(smsMessage)}` : ''}`;
                    break;
                case 'wifi':
                    const ssid = document.getElementById('qrWifiSsid')?.value || '';
                    const password = document.getElementById('qrWifiPassword')?.value || '';
                    const security = document.getElementById('qrWifiSecurity')?.value || 'WPA';
                    qrData = `WIFI:T:${security};S:${ssid};P:${password};;`;
                    break;
                case 'vcard':
                    const name = document.getElementById('qrVcardName')?.value || '';
                    const phone = document.getElementById('qrVcardPhone')?.value || '';
                    const vcardEmail = document.getElementById('qrVcardEmail')?.value || '';
                    const company = document.getElementById('qrVcardCompany')?.value || '';
                    qrData = `BEGIN:VCARD\nVERSION:3.0\nFN:${name}\nTEL:${phone}\nEMAIL:${vcardEmail}\nORG:${company}\nEND:VCARD`;
                    break;
            }
            
            if (!qrData.trim()) {
                showToast('Please fill in the required fields', 'error');
                return;
            }
            
            const canvas = document.getElementById('qrCanvas');
            const placeholder = document.getElementById('qrPlaceholder');
            
            if (typeof QRCode !== 'undefined') {
                QRCode.toCanvas(canvas, qrData, {
                    width: size,
                    margin: 2,
                    color: {
                        dark: foreground,
                        light: background
                    },
                    errorCorrectionLevel: errorLevel
                }, function (error) {
                    if (error) {
                        showToast('Error generating QR code', 'error');
                        console.error(error);
                    } else {
                        canvas.style.display = 'block';
                        placeholder.style.display = 'none';
                        document.getElementById('downloadQrBtn').style.display = 'inline-block';
                        showToast('QR code generated successfully!', 'success');
                    }
                });
            } else {
                showToast('QR code library not loaded', 'error');
            }
        }

        function downloadQrCode() {
            const canvas = document.getElementById('qrCanvas');
            const qrType = document.getElementById('qrType').value;
            
            canvas.toBlob(function(blob) {
                const filename = `qrcode_${qrType}_${Date.now()}.png`;
                downloadBlob(blob, filename);
                showToast('QR code downloaded!', 'success');
            });
        }

        // Calculator Functions
        function calcNumber(num) {
            if (calcState.waitingForOperand) {
                calcState.display = num;
                calcState.waitingForOperand = false;
            } else {
                calcState.display = calcState.display === '0' ? num : calcState.display + num;
            }
            updateCalcDisplay();
        }

        function calcOperation(nextOperation) {
            const inputValue = parseFloat(calcState.display);

            if (calcState.previousValue === null) {
                calcState.previousValue = inputValue;
            } else if (calcState.operation) {
                const currentValue = calcState.previousValue || 0;
                const newValue = calculate(currentValue, inputValue, calcState.operation);

                calcState.display = String(newValue);
                calcState.previousValue = newValue;
            }

            calcState.waitingForOperand = true;
            calcState.operation = nextOperation;
            updateCalcDisplay();
        }

        function calcEquals() {
            const inputValue = parseFloat(calcState.display);

            if (calcState.previousValue !== null && calcState.operation) {
                const currentValue = calcState.previousValue || 0;
                const newValue = calculate(currentValue, inputValue, calcState.operation);
                
                const calculation = `${currentValue} ${calcState.operation} ${inputValue} = ${newValue}`;
                calcState.history.push(calculation);
                if (calcState.history.length > 10) calcState.history.shift();

                calcState.display = String(newValue);
                calcState.previousValue = null;
                calcState.operation = null;
                calcState.waitingForOperand = true;
                updateCalcDisplay();
                updateCalcHistory();
            }
        }

        function calcFunction(func) {
            const inputValue = parseFloat(calcState.display);
            let result;

            switch (func) {
                case 'sin':
                    result = Math.sin(inputValue * Math.PI / 180);
                    break;
                case 'cos':
                    result = Math.cos(inputValue * Math.PI / 180);
                    break;
                case 'tan':
                    result = Math.tan(inputValue * Math.PI / 180);
                    break;
                case 'sqrt':
                    result = Math.sqrt(inputValue);
                    break;
                case 'pow':
                    result = inputValue * inputValue;
                    break;
                case 'pow3':
                    result = inputValue * inputValue * inputValue;
                    break;
                case 'log':
                    result = Math.log10(inputValue);
                    break;
                case 'ln':
                    result = Math.log(inputValue);
                    break;
                case 'exp':
                    result = Math.exp(inputValue);
                    break;
                case 'reciprocal':
                    result = 1 / inputValue;
                    break;
                default:
                    return;
            }

            const calculation = `${func}(${inputValue}) = ${result}`;
            calcState.history.push(calculation);
            if (calcState.history.length > 10) calcState.history.shift();

            calcState.display = String(result);
            calcState.waitingForOperand = true;
            updateCalcDisplay();
            updateCalcHistory();
        }

        function calculate(firstValue, secondValue, operation) {
            switch (operation) {
                case '+':
                    return firstValue + secondValue;
                case '-':
                    return firstValue - secondValue;
                case '*':
                    return firstValue * secondValue;
                case '/':
                    return secondValue !== 0 ? firstValue / secondValue : 0;
                case '%':
                    return firstValue % secondValue;
                case '±':
                    return -firstValue;
                default:
                    return secondValue;
            }
        }

        function clearCalc() {
            calcState.display = '0';
            calcState.previousValue = null;
            calcState.operation = null;
            calcState.waitingForOperand = false;
            updateCalcDisplay();
        }

        function clearHistory() {
            calcState.history = [];
            updateCalcHistory();
        }

        function updateCalcDisplay() {
            document.getElementById('calcDisplay').value = calcState.display;
            document.getElementById('calcHistory').textContent = calcState.history.slice(-1)[0] || '';
        }

        function updateCalcHistory() {
            const historyList = document.getElementById('calcHistoryList');
            if (calcState.history.length === 0) {
                historyList.innerHTML = '<p style="color: #666; font-style: italic;">No calculations yet</p>';
            } else {
                historyList.innerHTML = calcState.history.slice(-5).reverse().map(calc => 
                    `<div style="padding: 5px; border-bottom: 1px solid #eee; font-family: monospace;">${calc}</div>`
                ).join('');
            }
        }

        // Text Tools Functions
        function updateTextStats() {
            const text = document.getElementById('textInput').value;
            
            const wordCount = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            const charCount = text.length;
            const charCountNoSpaces = text.replace(/\s/g, '').length;
            const paragraphCount = text.trim() === '' ? 0 : text.split(/\n\s*\n/).filter(p => p.trim()).length;
            const sentenceCount = text.trim() === '' ? 0 : text.split(/[.!?]+/).filter(s => s.trim()).length;
            const readingTime = Math.ceil(wordCount / 200);
            
            document.getElementById('wordCount').textContent = wordCount.toLocaleString();
            document.getElementById('charCount').textContent = charCount.toLocaleString();
            document.getElementById('charCountNoSpaces').textContent = charCountNoSpaces.toLocaleString();
            document.getElementById('paragraphCount').textContent = paragraphCount.toLocaleString();
            document.getElementById('sentenceCount').textContent = sentenceCount.toLocaleString();
            document.getElementById('readingTime').textContent = readingTime.toLocaleString();
        }

        function loadTextFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                if (file.type === 'text/plain') {
                    document.getElementById('textInput').value = e.target.result;
                    updateTextStats();
                } else if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                    if (typeof mammoth !== 'undefined') {
                        const arrayBuffer = e.target.result;
                        mammoth.extractRawText({arrayBuffer: arrayBuffer})
                            .then(function(result) {
                                document.getElementById('textInput').value = result.value;
                                updateTextStats();
                                showToast('Word document loaded successfully!', 'success');
                            })
                            .catch(function(err) {
                                showToast('Error reading Word document', 'error');
                            });
                    } else {
                        showToast('Word document support not available', 'error');
                    }
                }
            };

            if (file.type === 'text/plain') {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function textTransform(type) {
            const textArea = document.getElementById('textInput');
            let text = textArea.value;
            
            switch (type) {
                case 'uppercase':
                    text = text.toUpperCase();
                    break;
                case 'lowercase':
                    text = text.toLowerCase();
                    break;
                case 'capitalize':
                    text = text.replace(/\b\w/g, l => l.toUpperCase());
                    break;
                case 'title':
                    text = text.replace(/\w\S*/g, (txt) => 
                        txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
                    break;
            }
            
            textArea.value = text;
            updateTextStats();
        }

        function clearText() {
            document.getElementById('textInput').value = '';
            updateTextStats();
        }

        function copyText() {
            const textArea = document.getElementById('textInput');
            textArea.select();
            document.execCommand('copy');
            showToast('Text copied to clipboard!', 'success');
        }

        // File Name Modal Functions
        function showFilenameModal(title, defaultName, callback) {
            document.getElementById('filenameModalTitle').textContent = title;
            document.getElementById('customFileName').value = defaultName;
            document.getElementById('filenameModal').classList.add('active');
            pendingDownload = callback;
        }

        function hideFilenameModal() {
            document.getElementById('filenameModal').classList.remove('active');
            pendingDownload = null;
        }

        function confirmFileName() {
            const fileName = document.getElementById('customFileName').value.trim();
            if (fileName && pendingDownload) {
                pendingDownload(fileName);
            }
            hideFilenameModal();
        }

        // Processing Overlay Functions
        function showProcessing(title, status) {
            document.getElementById('processingTitle').textContent = title;
            document.getElementById('processingStatus').textContent = status;
            document.getElementById('processingProgress').style.width = '0%';
            document.getElementById('processingDetails').textContent = 'Initializing...';
            document.getElementById('processingOverlay').classList.add('active');
        }

        function hideProcessing() {
            document.getElementById('processingOverlay').classList.remove('active');
        }

        function updateProcessingProgress(current, total, details) {
            const percent = ((current + 1) / total) * 100;
            document.getElementById('processingProgress').style.width = percent + '%';
            document.getElementById('processingDetails').textContent = details || `Processing ${current + 1} of ${total}...`;
        }

        // Modal Functions
        function showPricing() {
            document.getElementById('pricingModal').classList.add('active');
        }

        function hidePricing() {
            document.getElementById('pricingModal').classList.remove('active');
        }

        // Toast Notification System
        function showToast(message, type = 'info', duration = 4000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            const container = document.getElementById('toastContainer');
            if (!container) {
                const newContainer = document.createElement('div');
                newContainer.id = 'toastContainer';
                document.body.appendChild(newContainer);
            }
            
            const toastContainer = document.getElementById('toastContainer');
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toastContainer.contains(toast)) {
                        toastContainer.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // Initialize all components
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateTextStats();
            updateCalcDisplay();
            updateCalcHistory();
            initializeImageEditor();
            updateQrInputs();
        });
    </script>
</body>
</html>
                
